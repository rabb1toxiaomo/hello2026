# 服务器配置要求和建议

## 📊 项目资源需求分析

### 技术栈特点
- **后端**: Node.js + Express（轻量级框架）
- **数据库**: SQL.js (SQLite) - 文件数据库，轻量级
- **前端**: 静态文件，无需构建
- **内存使用**: PM2 配置限制为 500MB

### 资源消耗估算

#### CPU 使用
- **基础运行**: 单核即可，Node.js 单线程模型
- **并发处理**: 2核心可以很好地处理并发请求
- **峰值**: 高并发时 2核心足够

#### 内存使用
- **Node.js 进程**: 约 100-200MB（基础）
- **SQL.js 数据库**: 约 50-100MB（取决于数据量）
- **在线用户缓存**: 约 10-50MB（Map 存储）
- **速率限制缓存**: 约 10-30MB
- **系统预留**: 约 500MB（操作系统）
- **总计估算**: 约 700MB - 1GB（正常使用）

#### 磁盘空间
- **项目文件**: 约 50MB
- **node_modules**: 约 100MB
- **数据库文件**: 取决于数据量（每条消息约 1KB）
  - 1000 条消息 ≈ 1MB
  - 10000 条消息 ≈ 10MB
- **日志文件**: 建议限制大小，轮转保留
- **总计建议**: 至少 500MB 可用空间

---

## ✅ 2核心4G 配置评估

### **结论：完全够用！** ✅

对于这个项目，**2核心4G内存**的配置是**完全够用**的，甚至还有余量。

### 详细分析

#### ✅ CPU（2核心）
- **单进程模式**: 1核心即可运行，2核心有充足余量
- **集群模式**: 可以使用 2核心运行 2个实例，提高并发能力
- **建议**: 使用 PM2 集群模式（`instances: 2`）充分利用双核

#### ✅ 内存（4GB）
- **项目需求**: 约 700MB - 1GB
- **系统预留**: 约 500MB - 1GB
- **可用余量**: 约 2GB - 2.5GB
- **结论**: 内存充足，可以支持：
  - 同时在线用户：1000+ 人
  - 消息数量：10万+ 条
  - 数据库大小：100MB+

---

## 🎯 推荐配置

### 最低配置（够用）
- **CPU**: 1核心
- **内存**: 2GB
- **磁盘**: 20GB
- **适用场景**: 小规模使用（< 100 在线用户）

### 推荐配置（最佳性价比）⭐
- **CPU**: 2核心
- **内存**: 4GB
- **磁盘**: 40GB
- **适用场景**: 中等规模使用（100-1000 在线用户）

### 高性能配置（有余量）
- **CPU**: 4核心
- **内存**: 8GB
- **磁盘**: 80GB
- **适用场景**: 大规模使用（1000+ 在线用户）

---

## ⚙️ 优化建议（针对 2核心4G）

### 1. PM2 配置优化

编辑 `ecosystem.config.js`:

```javascript
module.exports = {
  apps: [{
    name: 'hello2026',
    script: 'server.js',
    instances: 2,  // 使用 2 个实例，充分利用双核
    exec_mode: 'cluster',  // 集群模式
    max_memory_restart: '800M',  // 每个实例最多 800MB
    // ... 其他配置
  }]
};
```

**优势**:
- 充分利用双核 CPU
- 提高并发处理能力
- 单实例崩溃不影响整体服务

### 2. 内存优化

```javascript
// 在 ecosystem.config.js 中
max_memory_restart: '800M',  // 每个实例限制 800MB
```

**说明**:
- 2个实例 × 800MB = 1.6GB（项目使用）
- 系统预留 500MB - 1GB
- 总使用约 2.1GB - 2.6GB，4GB 内存充足

### 3. 速率限制优化

如果用户量很大，可以考虑：
- 使用 Redis 替代内存 Map（需要额外内存，但更高效）
- 或者保持当前简单实现（4GB 内存足够）

### 4. 日志管理

```bash
# 安装日志轮转
pm2 install pm2-logrotate

# 配置日志大小和保留
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

防止日志文件占用过多磁盘空间。

### 5. 数据库优化

- SQLite 数据库文件会自动增长
- 建议定期备份：`cp wishes.db wishes.db.backup`
- 如果数据量很大（> 1GB），考虑数据归档

---

## 📈 性能预期（2核心4G）

### 并发能力
- **同时在线用户**: 500-1000 人
- **每秒请求数**: 50-100 个
- **响应时间**: < 100ms（正常情况）

### 数据容量
- **用户数量**: 10万+
- **消息数量**: 50万+
- **数据库大小**: 500MB - 1GB

### 稳定性
- **7×24小时运行**: ✅ 支持
- **自动重启**: ✅ PM2 已配置
- **内存溢出保护**: ✅ max_memory_restart 已配置

---

## 🔍 监控建议

### 1. 资源监控

```bash
# 查看 PM2 状态
pm2 status

# 查看资源使用
pm2 monit

# 查看详细统计
pm2 describe hello2026
```

### 2. 系统监控

```bash
# 查看内存使用
free -h

# 查看 CPU 使用
top

# 查看磁盘使用
df -h
```

### 3. 应用监控

定期检查：
- 在线用户数量
- 数据库文件大小
- 日志文件大小
- 响应时间

---

## ⚠️ 注意事项

### 1. 内存使用
- 虽然 4GB 足够，但要监控实际使用情况
- 如果接近 3.5GB，考虑优化或升级

### 2. 数据库增长
- SQLite 数据库会持续增长
- 定期备份和清理旧数据

### 3. 日志管理
- 配置日志轮转，防止日志文件过大
- 定期清理旧日志

### 4. 并发峰值
- 如果遇到突发高并发，2核心可能成为瓶颈
- 可以考虑升级到 4核心

---

## 🚀 部署建议

### 对于 2核心4G 配置：

1. **使用 PM2 集群模式**
   ```bash
   # 修改 ecosystem.config.js
   instances: 2,
   exec_mode: 'cluster'
   ```

2. **配置内存限制**
   ```javascript
   max_memory_restart: '800M'
   ```

3. **启用日志轮转**
   ```bash
   pm2 install pm2-logrotate
   ```

4. **设置健康检查**
   ```bash
   # 使用 healthcheck.sh
   */5 * * * * /path/to/app/healthcheck.sh
   ```

5. **监控资源使用**
   ```bash
   pm2 monit  # 实时监控
   ```

---

## 📊 总结

### ✅ 2核心4G 够用吗？

**完全够用！** 对于这个项目：

- ✅ **CPU**: 2核心充足，可以使用集群模式
- ✅ **内存**: 4GB 充足，可以支持大规模使用
- ✅ **稳定性**: 可以 7×24 小时稳定运行
- ✅ **性能**: 可以支持 500-1000 同时在线用户

### 💡 建议

1. **使用 PM2 集群模式**充分利用双核
2. **配置内存限制**防止内存溢出
3. **启用日志轮转**管理日志文件
4. **定期监控**资源使用情况

如果后续用户量增长到 1000+，再考虑升级到 4核心8G。

---

*最后更新: 2025-12-31*

